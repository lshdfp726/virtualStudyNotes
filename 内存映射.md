### 内存映射

#### 基本概念

计算机系统将讯内存区域和磁盘上的对象关联起来，以初始化这个虚拟内存区域，这个过程称为内存映射

1、虚拟内存区域映射到普通磁盘文件， 按照虚拟内存特性会把磁盘文件分成页大小的片，每一片包含虚拟页面的初始化内容，此时这些虚拟页面没有进行磁盘交换进入物理内存，直到CPU 第一次引用该虚拟页，进入缺页处理流程。才会实际占用物理内存。 如果虚拟地址覆盖的区域区域比文件区域要大，那么就用零来填充这个区域。

2、匿名文件：一个区域也可以映射到匿名文件，匿名文件由内核创建，包含全是二进制零。CPU 第一次引用该虚拟页，触发缺页流程。

总结：内存映射产生的虚拟内存没使用直接是不会占用物理内存，无形中就提升物理内存使用效率。



#### 写时复制

虚拟内存映射到私有区域，这个区域没发生写入之前 性质和共享区域一样，一旦发生写入，触发系统保护故障，系统会在物理内存中创建一个副本页，这个过程叫写时复制

#### fork 函数:

在已知进程调用forr 创建新的进程，内核通过复制当前进程的各种数据结构（页表、task任务结构，mmap，内核栈等等)给新进程，并分配唯一的PID，并标记这些数据结构为私有写时复制，2个进程的每个页标记为只读。这样两个进程在后续任何时候 进行写操作时候，写时复制机制就创建新的私有页面。

#### execve 函数:

1、删除已经存在的用户区域: 删除当前进程虚拟地址的用户部分已经存在的区域结构，

2、映射私有区域: 为新程序的代码、数据、bss和栈区创建新的区域结构。这些都是写时复制。走的是匿名文件内存映射路子。

3、映射共享区域: 把一些标准库先动态链接到这个程序，然后在映射到用户虚拟地址空间中的共享区域。

4、设置程序计数器(PC):  把当前进程程序计数器，指向代码区域的入口点。

#### 用户地址空间分布图

![截屏2023-12-27 11.26.35](/Users/fu-mobile/Library/Application Support/typora-user-images/截屏2023-12-27 11.26.35.png)